<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Call Center Analysis</title>
    <link rel="stylesheet" href="default.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-content">
          <h1>Call Center Analysis</h1>
          <p class="header-subtitle">
            Audio transcription and conversation insights dashboard
          </p>
        </div>
      </div>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-value" id="totalCalls">0</div>
          <div class="stat-label">Total Calls</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="positiveCalls">0</div>
          <div class="stat-label">Positive</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="neutralCalls">0</div>
          <div class="stat-label">Neutral</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="negativeCalls">0</div>
          <div class="stat-label">Negative</div>
        </div>
      </div>

      <div class="toolbar">
        <div class="search-box">
          <input
            type="text"
            id="searchInput"
            placeholder="Search calls..."
            aria-label="Search calls"
          />
        </div>
        <div class="toolbar-actions">
          <button class="btn-secondary" id="analyzeBtn">
            <span>üìä</span>
            <span>Analyze Patterns</span>
          </button>
          <button class="btn-primary" id="newCallBtn">
            <span>‚ûï</span>
            <span>New Transcription</span>
          </button>
        </div>
      </div>

      <div class="card">
        <div class="table-container">
          <table id="callsTable">
            <thead>
              <tr>
                <th class="sortable" data-column="row_number">ID</th>
                <th class="sortable" data-column="message_content_call_title">
                  Call Title
                </th>
                <th class="sortable" data-column="filename">File</th>
                <th
                  class="sortable"
                  data-column="message_content_overall_sentiment"
                >
                  Sentiment
                </th>
                <th
                  class="sortable"
                  data-column="message_content_questions_quality_score"
                >
                  Quality
                </th>
                <th class="sortable" data-column="result">Result</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td colspan="7" class="loading">Loading data...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal slideshow-modal" id="analysisModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Pattern Analysis & Insights</h2>
          <button
            class="modal-close"
            id="closeAnalysisModal"
            aria-label="Close modal"
          >
            √ó
          </button>
        </div>
        <div class="slideshow-container" id="slideshowContainer">
          <!-- Slides will be dynamically inserted here -->
        </div>
        <div class="slide-navigation">
          <div class="slide-counter">
            <span id="currentSlide">1</span> / <span id="totalSlides">5</span>
          </div>
          <div class="slide-nav-buttons">
            <button class="slide-nav-btn" id="prevSlide">‚Üê Previous</button>
            <button class="slide-nav-btn" id="nextSlide">Next ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="detailModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="detailModalTitle">Call Details</h2>
          <button
            class="modal-close"
            id="closeDetailModal"
            aria-label="Close modal"
          >
            √ó
          </button>
        </div>
        <div
          class="modal-body"
          style="padding: 2rem; max-height: 70vh; overflow-y: auto"
        >
          <div id="detailModalContent"></div>
        </div>
      </div>
    </div>

    <script>
      // Configuration - UPDATE THESE URLs
      const CONFIG = {
        webhookUrl:
          "https://klett-agent.app.n8n.cloud/webhook/d22b7bdf-786d-4707-ac3f-5c784ac61878",
        formUrl:
          "https://klett-agent.app.n8n.cloud/form/5dd5f0b9-4583-4250-98bf-e4e388219ecd",
      };

      // State
      let callsData = [];
      let filteredData = [];
      let sortColumn = null;
      let sortDirection = "asc";
      let currentSlideIndex = 0;
      let analysisData = null;

      // DOM Elements
      const tableBody = document.getElementById("tableBody");
      const searchInput = document.getElementById("searchInput");
      const newCallBtn = document.getElementById("newCallBtn");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const analysisModal = document.getElementById("analysisModal");
      const closeAnalysisModal = document.getElementById("closeAnalysisModal");
      const slideshowContainer = document.getElementById("slideshowContainer");
      const prevSlideBtn = document.getElementById("prevSlide");
      const nextSlideBtn = document.getElementById("nextSlide");
      const currentSlideSpan = document.getElementById("currentSlide");
      const totalSlidesSpan = document.getElementById("totalSlides");
      const detailModal = document.getElementById("detailModal");
      const closeDetailModal = document.getElementById("closeDetailModal");
      const detailModalTitle = document.getElementById("detailModalTitle");
      const detailModalContent = document.getElementById("detailModalContent");
      const statsElements = {
        total: document.getElementById("totalCalls"),
        positive: document.getElementById("positiveCalls"),
        neutral: document.getElementById("neutralCalls"),
        negative: document.getElementById("negativeCalls"),
      };

      // Fetch data from n8n webhook
      async function fetchData() {
        try {
          const response = await fetch(CONFIG.webhookUrl);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();

          console.log("Raw webhook data:", data);
          console.log("Data type:", typeof data);
          console.log("Is array:", Array.isArray(data));

          // Handle different possible response structures
          let processedData = [];

          if (Array.isArray(data)) {
            processedData = data;
          } else if (data && typeof data === "object") {
            // Check for common wrapper properties
            if (data.items && Array.isArray(data.items)) {
              processedData = data.items;
            } else if (data.data && Array.isArray(data.data)) {
              processedData = data.data;
            } else if (data.rows && Array.isArray(data.rows)) {
              processedData = data.rows;
            } else if (data.results && Array.isArray(data.results)) {
              processedData = data.results;
            } else {
              // If it's a single object, wrap it in an array
              processedData = [data];
            }
          }

          console.log("Processed data:", processedData);
          console.log("Number of items:", processedData.length);

          callsData = processedData;
          filteredData = [...callsData];

          updateStats();
          renderTable();
        } catch (error) {
          console.error("Error fetching data:", error);
          tableBody.innerHTML = `
            <tr>
              <td colspan="7" class="error-message">
                Error loading data: ${error.message}
                <br><small>Please check your webhook URL configuration</small>
              </td>
            </tr>
          `;
        }
      }

      // Update statistics
      function updateStats() {
        const stats = {
          total: callsData.length,
          positive: 0,
          neutral: 0,
          negative: 0,
        };

        callsData.forEach((call) => {
          const sentiment = (
            call.message_content_overall_sentiment || ""
          ).toLowerCase();
          if (sentiment === "positive") stats.positive++;
          else if (sentiment === "neutral") stats.neutral++;
          else if (sentiment === "negative") stats.negative++;
        });

        statsElements.total.textContent = stats.total;
        statsElements.positive.textContent = stats.positive;
        statsElements.neutral.textContent = stats.neutral;
        statsElements.negative.textContent = stats.negative;
      }

      // Render table
      function renderTable() {
        console.log("Rendering table with filteredData:", filteredData);
        console.log("filteredData.length:", filteredData.length);

        if (!filteredData || filteredData.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="7" class="empty-state">
                No calls found. Click "New Transcription" to add one.
              </td>
            </tr>
          `;
          return;
        }

        tableBody.innerHTML = filteredData
          .map((call, index) => {
            console.log(`Rendering row ${index}:`, call);
            return `
          <tr>
            <td>${call.row_number || index + 1}</td>
            <td>${escapeHtml(call.message_content_call_title || "Untitled Call")}</td>
            <td>${escapeHtml(call.filename || "N/A")}</td>
            <td>${renderSentimentBadge(call.message_content_overall_sentiment)}</td>
            <td>${renderQualityBadge(call.message_content_questions_quality_score)}</td>
            <td>${renderResultBadge(call.result)}</td>
            <td>
              <a href="#" class="action-link" onclick="showCallDetails(${index}); return false;">
                View Details ‚Üí
              </a>
            </td>
          </tr>
        `;
          })
          .join("");
      }

      // Show call details in modal
      function showCallDetails(index) {
        const call = filteredData[index];
        detailModalTitle.textContent =
          call.message_content_call_title || "Call Details";

        const detailsHTML = `
          <div style="display: grid; gap: 1.5rem;">
            <div class="insight-card">
              <div class="insight-header">
                <span class="insight-icon">üìã</span>
                <h3 class="insight-title">Call Summary</h3>
              </div>
              <div class="insight-body">
                ${escapeHtml(call.message_content_call_summary || "No summary available")}
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
              <div class="stat-card">
                <div class="stat-label">Rep Talk Ratio</div>
                <div class="stat-value" style="font-size: 1.5rem;">${call.message_content_talk_ratio_rep_percent || 0}%</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Customer Talk Ratio</div>
                <div class="stat-value" style="font-size: 1.5rem;">${call.message_content_talk_ratio_customer_percent || 0}%</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Total Questions</div>
                <div class="stat-value" style="font-size: 1.5rem;">${call.message_content_questions_total || 0}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Impact Questions</div>
                <div class="stat-value" style="font-size: 1.5rem;">${call.message_content_questions_impact_count || 0}</div>
              </div>
            </div>

            ${
              call.message_content_talk_ratio_analysis
                ? `
            <div class="insight-card">
              <div class="insight-header">
                <span class="insight-icon">üí¨</span>
                <h3 class="insight-title">Talk Ratio Analysis</h3>
              </div>
              <div class="insight-body">
                ${escapeHtml(call.message_content_talk_ratio_analysis)}
              </div>
            </div>
            `
                : ""
            }

            ${
              call.message_content_questions_analysis
                ? `
            <div class="insight-card">
              <div class="insight-header">
                <span class="insight-icon">‚ùì</span>
                <h3 class="insight-title">Questions Analysis</h3>
              </div>
              <div class="insight-body">
                ${escapeHtml(call.message_content_questions_analysis)}
              </div>
            </div>
            `
                : ""
            }

            ${
              call.message_content_impact_questions
                ? `
            <div class="insight-card">
              <div class="insight-header">
                <span class="insight-icon">üéØ</span>
                <h3 class="insight-title">Impact Questions</h3>
              </div>
              <div class="insight-body">
                ${escapeHtml(call.message_content_impact_questions)}
              </div>
            </div>
            `
                : ""
            }

            ${
              call.message_content_key_strengths
                ? `
            <div class="insight-card">
              <div class="insight-header">
                <span class="insight-icon">‚úÖ</span>
                <h3 class="insight-title">Key Strengths</h3>
              </div>
              <div class="insight-body">
                ${escapeHtml(call.message_content_key_strengths)}
              </div>
            </div>
            `
                : ""
            }

            ${
              call.message_content_key_weaknesses
                ? `
            <div class="insight-card">
              <div class="insight-header">
                <span class="insight-icon">‚ö†Ô∏è</span>
                <h3 class="insight-title">Areas for Improvement</h3>
              </div>
              <div class="insight-body">
                ${escapeHtml(call.message_content_key_weaknesses)}
              </div>
            </div>
            `
                : ""
            }

            ${
              call.message_content_top_3_recommendations
                ? `
            <div class="insight-card">
              <div class="insight-header">
                <span class="insight-icon">üí°</span>
                <h3 class="insight-title">Top Recommendations</h3>
              </div>
              <div class="insight-body">
                ${escapeHtml(call.message_content_top_3_recommendations)}
              </div>
            </div>
            `
                : ""
            }
          </div>
        `;

        detailModalContent.innerHTML = detailsHTML;
        detailModal.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      // Make showCallDetails available globally
      window.showCallDetails = showCallDetails;

      // Render sentiment badge
      function renderSentimentBadge(sentiment) {
        if (!sentiment) return '<span class="badge info">Unknown</span>';

        const sentimentLower = sentiment.toLowerCase();
        let badgeClass = "neutral";

        if (sentimentLower === "positive") badgeClass = "positive";
        else if (sentimentLower === "negative") badgeClass = "negative";
        else if (sentimentLower === "neutral") badgeClass = "neutral";
        else badgeClass = "info";

        return `
          <span class="badge ${badgeClass}">
            <span class="badge-dot"></span>
            ${escapeHtml(sentiment)}
          </span>
        `;
      }

      // Render quality badge
      function renderQualityBadge(quality) {
        if (!quality) return '<span class="badge info">N/A</span>';

        const qualityUpper = quality.toUpperCase();
        let badgeClass = "neutral";

        if (qualityUpper === "HIGH") badgeClass = "positive";
        else if (qualityUpper === "LOW") badgeClass = "negative";
        else if (qualityUpper === "MEDIUM") badgeClass = "neutral";
        else badgeClass = "info";

        return `
          <span class="badge ${badgeClass}">
            <span class="badge-dot"></span>
            ${escapeHtml(quality)}
          </span>
        `;
      }

      // Render result badge
      function renderResultBadge(result) {
        if (!result) return '<span class="badge info">N/A</span>';

        const resultLower = result.toLowerCase();
        let badgeClass = "neutral";

        if (resultLower === "yes") badgeClass = "positive";
        else if (resultLower === "no") badgeClass = "negative";
        else badgeClass = "neutral";

        return `
          <span class="badge ${badgeClass}">
            <span class="badge-dot"></span>
            ${escapeHtml(result)}
          </span>
        `;
      }

      // Format date
      function formatDate(dateString) {
        if (!dateString) return "N/A";
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
        } catch (error) {
          return dateString;
        }
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Search functionality
      function handleSearch(query) {
        const searchTerm = query.toLowerCase().trim();

        if (!searchTerm) {
          filteredData = [...callsData];
        } else {
          filteredData = callsData.filter((call) => {
            return (
              (call.message_content_call_title || "")
                .toLowerCase()
                .includes(searchTerm) ||
              (call.filename || "").toLowerCase().includes(searchTerm) ||
              (call.message_content_overall_sentiment || "")
                .toLowerCase()
                .includes(searchTerm) ||
              (call.message_content_call_summary || "")
                .toLowerCase()
                .includes(searchTerm) ||
              (call.row_number || "").toString().includes(searchTerm)
            );
          });
        }

        renderTable();
      }

      // Sort functionality
      function sortTable(column) {
        if (sortColumn === column) {
          sortDirection = sortDirection === "asc" ? "desc" : "asc";
        } else {
          sortColumn = column;
          sortDirection = "asc";
        }

        filteredData.sort((a, b) => {
          let aVal = a[column] || "";
          let bVal = b[column] || "";

          // Handle different data types
          if (column === "row_number") {
            aVal = parseInt(aVal) || 0;
            bVal = parseInt(bVal) || 0;
          } else {
            aVal = aVal.toString().toLowerCase();
            bVal = bVal.toString().toLowerCase();
          }

          if (aVal < bVal) return sortDirection === "asc" ? -1 : 1;
          if (aVal > bVal) return sortDirection === "asc" ? 1 : -1;
          return 0;
        });

        updateSortIndicators();
        renderTable();
      }

      // Update sort indicators
      function updateSortIndicators() {
        document.querySelectorAll("th.sortable").forEach((th) => {
          th.classList.remove("sort-asc", "sort-desc");
          if (th.dataset.column === sortColumn) {
            th.classList.add(
              sortDirection === "asc" ? "sort-asc" : "sort-desc",
            );
          }
        });
      }

      // Pattern Analysis Functions
      function analyzePatterns() {
        if (callsData.length < 5) {
          alert(
            "Need at least 5 calls to perform meaningful pattern analysis.",
          );
          return;
        }

        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = "<span>‚è≥</span><span>Analyzing...</span>";

        // Simulate analysis
        setTimeout(() => {
          analysisData = performPatternAnalysis();
          generateSlides();
          openAnalysisModal();
          analyzeBtn.disabled = false;
          analyzeBtn.innerHTML = "<span>üìä</span><span>Analyze Patterns</span>";
        }, 2000);
      }

      function performPatternAnalysis() {
        // Group calls by quality score
        const qualityGroups = {
          HIGH: [],
          MEDIUM: [],
          LOW: [],
        };

        callsData.forEach((call) => {
          const quality = (
            call.message_content_questions_quality_score || ""
          ).toUpperCase();
          if (qualityGroups[quality]) {
            qualityGroups[quality].push(call);
          }
        });

        // Calculate average metrics for each group
        const calculateAverage = (calls, field) => {
          if (calls.length === 0) return 0;
          const sum = calls.reduce(
            (acc, call) => acc + (parseInt(call[field]) || 0),
            0,
          );
          return (sum / calls.length).toFixed(1);
        };

        const highPerformers = qualityGroups.HIGH.slice(0, 5).map((call) => ({
          title: call.message_content_call_title || "Untitled",
          successRate: call.message_content_questions_quality_score,
          impactQuestions: call.message_content_questions_impact_count || 0,
          sentiment: call.message_content_overall_sentiment || "neutral",
        }));

        const lowPerformers = qualityGroups.LOW.slice(0, 5).map((call) => ({
          title: call.message_content_call_title || "Untitled",
          successRate: call.message_content_questions_quality_score,
          impactQuestions: call.message_content_questions_impact_count || 0,
          sentiment: call.message_content_overall_sentiment || "neutral",
        }));

        // Identify patterns
        const patterns = identifyPatterns(qualityGroups);
        const recommendations = generateRecommendations(
          patterns,
          highPerformers,
          lowPerformers,
        );

        return {
          top5: highPerformers,
          bottom5: lowPerformers,
          patterns,
          recommendations,
          totalAnalyzed: callsData.length,
        };
      }

      function identifyPatterns(qualityGroups) {
        const patterns = [];

        const highCount = qualityGroups.HIGH.length;
        const mediumCount = qualityGroups.MEDIUM.length;
        const lowCount = qualityGroups.LOW.length;

        patterns.push({
          title: "Quality Distribution Analysis",
          description: `Out of ${callsData.length} calls analyzed: ${highCount} high quality (${((highCount / callsData.length) * 100).toFixed(1)}%), ${mediumCount} medium quality (${((mediumCount / callsData.length) * 100).toFixed(1)}%), and ${lowCount} low quality (${((lowCount / callsData.length) * 100).toFixed(1)}%). This distribution indicates ${highCount > lowCount ? "strong overall performance" : "significant room for improvement"}.`,
        });

        // Analyze impact questions correlation
        const avgHighImpact =
          qualityGroups.HIGH.reduce(
            (sum, call) =>
              sum +
              (parseInt(call.message_content_questions_impact_count) || 0),
            0,
          ) / (qualityGroups.HIGH.length || 1);
        const avgLowImpact =
          qualityGroups.LOW.reduce(
            (sum, call) =>
              sum +
              (parseInt(call.message_content_questions_impact_count) || 0),
            0,
          ) / (qualityGroups.LOW.length || 1);

        patterns.push({
          title: "Impact Questions Correlation",
          description: `High-quality calls average ${avgHighImpact.toFixed(1)} impact questions, while low-quality calls average ${avgLowImpact.toFixed(1)}. This ${(avgHighImpact - avgLowImpact).toFixed(1)} question difference demonstrates the importance of asking meaningful, impact-driven questions.`,
        });

        // Sentiment analysis
        const positiveCount = callsData.filter(
          (c) =>
            (c.message_content_overall_sentiment || "").toLowerCase() ===
            "positive",
        ).length;

        patterns.push({
          title: "Sentiment Pattern",
          description: `${((positiveCount / callsData.length) * 100).toFixed(1)}% of calls resulted in positive sentiment. High-quality questioning techniques and effective communication strategies correlate strongly with positive customer sentiment.`,
        });

        return patterns;
      }

      function generateRecommendations(patterns, top5, bottom5) {
        return [
          "Focus on increasing the number of impact questions per call. Data shows high-performing calls ask significantly more impact questions that drive meaningful conversations.",
          "Implement training on effective questioning techniques, emphasizing open-ended questions that uncover customer needs and pain points.",
          "Review and analyze recordings of high-quality calls to identify specific phrases, approaches, and techniques that lead to positive outcomes.",
          "Establish quality benchmarks based on impact question count and sentiment scores, with regular coaching sessions for team members below threshold.",
          "Create a feedback loop where representatives can learn from both successful and unsuccessful calls, focusing on continuous improvement in conversation quality.",
        ];
      }

      function generateSlides() {
        const slides = [
          // Slide 1: Title
          `
            <div class="slide active">
              <div class="slide-content">
                <h1 class="slide-title">Call Quality Analysis</h1>
                <p class="slide-subtitle">Pattern Recognition & Strategic Insights</p>
                <div class="insight-card">
                  <div class="insight-header">
                    <span class="insight-icon">üìä</span>
                    <h3 class="insight-title">Analysis Overview</h3>
                  </div>
                  <div class="insight-body">
                    This comprehensive analysis examines ${analysisData.totalAnalyzed} call center conversations,
                    identifying key performance patterns based on question quality, sentiment analysis, and conversation effectiveness.
                    The analysis compares high and low-quality calls to extract best practices and areas for development.
                  </div>
                </div>
              </div>
            </div>
          `,
          // Slide 2: Top vs Bottom Performers
          `
            <div class="slide">
              <div class="slide-content">
                <h2 class="slide-title">Quality Comparison</h2>
                <p class="slide-subtitle">High Quality vs Low Quality Calls</p>
                <div class="comparison-grid">
                  <div class="comparison-section top">
                    <h3 class="comparison-title top">üèÜ High Quality Calls</h3>
                    <ul class="performer-list">
                      ${
                        analysisData.top5.length > 0
                          ? analysisData.top5
                              .map(
                                (p) => `
                        <li class="performer-item">
                          <span class="performer-name">${escapeHtml(p.title)}</span>
                          <span class="performer-score" style="color: var(--color-success);">${p.impactQuestions} impact Q's</span>
                        </li>
                      `,
                              )
                              .join("")
                          : '<li class="performer-item"><span class="performer-name">No high-quality calls found</span></li>'
                      }
                    </ul>
                  </div>
                  <div class="comparison-section bottom">
                    <h3 class="comparison-title bottom">üìâ Needs Improvement</h3>
                    <ul class="performer-list">
                      ${
                        analysisData.bottom5.length > 0
                          ? analysisData.bottom5
                              .map(
                                (p) => `
                        <li class="performer-item">
                          <span class="performer-name">${escapeHtml(p.title)}</span>
                          <span class="performer-score" style="color: var(--color-error);">${p.impactQuestions} impact Q's</span>
                        </li>
                      `,
                              )
                              .join("")
                          : '<li class="performer-item"><span class="performer-name">No low-quality calls found</span></li>'
                      }
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          `,
          // Slide 3: Identified Patterns
          `
            <div class="slide">
              <div class="slide-content">
                <h2 class="slide-title">Key Patterns Identified</h2>
                <p class="slide-subtitle">Data-Driven Insights from Conversation Analysis</p>
                <ul class="pattern-list">
                  ${analysisData.patterns
                    .map(
                      (pattern) => `
                    <li class="pattern-item">
                      <div class="pattern-title">${escapeHtml(pattern.title)}</div>
                      <div class="pattern-description">${escapeHtml(pattern.description)}</div>
                    </li>
                  `,
                    )
                    .join("")}
                </ul>
              </div>
            </div>
          `,
          //Slide 4: Recommendations
          `
            <div class="slide">
              <div class="slide-content">
                <h2 class="slide-title">Strategic Recommendations</h2>
                <p class="slide-subtitle">Action Plan for Quality Improvement</p>
                <ul class="recommendation-list">
                  ${analysisData.recommendations
                    .map(
                      (rec, idx) => `
                    <li class="recommendation-item">
                      <div class="recommendation-number">${idx + 1}</div>
                      <div class="recommendation-text">${escapeHtml(rec)}</div>
                    </li>
                  `,
                    )
                    .join("")}
                </ul>
              </div>
            </div>
          `,
          // Slide 5: Summary
          `
            <div class="slide">
              <div class="slide-content">
                <h2 class="slide-title">Next Steps</h2>
                <p class="slide-subtitle">Implementation Roadmap</p>
                <div class="insight-card">
                  <div class="insight-header">
                    <span class="insight-icon">üéØ</span>
                    <h3 class="insight-title">Immediate Actions</h3>
                  </div>
                  <div class="insight-body">
                    <strong>Week 1-2:</strong> Review high-quality call recordings and document effective questioning techniques and conversation patterns.
                    <br><br>
                    <strong>Week 3-4:</strong> Conduct training sessions focused on impact questions and implement quality scoring for all calls.
                    <br><br>
                    <strong>Month 2:</strong> Establish peer review sessions where team members analyze calls together and share best practices.
                    <br><br>
                    <strong>Ongoing:</strong> Weekly quality reviews and monthly pattern analysis to track improvement and adjust training focus.
                  </div>
                </div>
              </div>
            </div>
          `,
        ];

        slideshowContainer.innerHTML = slides.join("");
        totalSlidesSpan.textContent = slides.length;
        currentSlideIndex = 0;
        updateSlideNavigation();
      }

      function openAnalysisModal() {
        analysisModal.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closeAnalysisModalFunc() {
        analysisModal.classList.remove("active");
        document.body.style.overflow = "";
        currentSlideIndex = 0;
      }

      function closeDetailModalFunc() {
        detailModal.classList.remove("active");
        document.body.style.overflow = "";
      }

      function showSlide(index) {
        const slides = slideshowContainer.querySelectorAll(".slide");
        slides.forEach((slide, i) => {
          slide.classList.toggle("active", i === index);
        });
        currentSlideIndex = index;
        currentSlideSpan.textContent = index + 1;
        updateSlideNavigation();
      }

      function updateSlideNavigation() {
        const slides = slideshowContainer.querySelectorAll(".slide");
        prevSlideBtn.disabled = currentSlideIndex === 0;
        nextSlideBtn.disabled = currentSlideIndex === slides.length - 1;
      }

      function nextSlide() {
        const slides = slideshowContainer.querySelectorAll(".slide");
        if (currentSlideIndex < slides.length - 1) {
          showSlide(currentSlideIndex + 1);
        }
      }

      function prevSlide() {
        if (currentSlideIndex > 0) {
          showSlide(currentSlideIndex - 1);
        }
      }

      // Modal functions
      function openNewTranscriptionForm() {
        console.log("Opening form in new window:", CONFIG.formUrl);
        window.open(CONFIG.formUrl, '_blank', 'noopener,noreferrer');
        // Refresh data after a delay to allow form submission
        setTimeout(() => fetchData(), 3000);
      }

      // Event listeners
      searchInput.addEventListener("input", (e) =>
        handleSearch(e.target.value),
      );

      document.querySelectorAll("th.sortable").forEach((th) => {
        th.addEventListener("click", () => sortTable(th.dataset.column));
      });

      newCallBtn.addEventListener("click", openNewTranscriptionForm);
      analyzeBtn.addEventListener("click", analyzePatterns);
      closeAnalysisModal.addEventListener("click", closeAnalysisModalFunc);
      closeDetailModal.addEventListener("click", closeDetailModalFunc);
      prevSlideBtn.addEventListener("click", prevSlide);
      nextSlideBtn.addEventListener("click", nextSlide);

      analysisModal.addEventListener("click", (e) => {
        if (e.target === analysisModal) closeAnalysisModalFunc();
      });

      detailModal.addEventListener("click", (e) => {
        if (e.target === detailModal) closeDetailModalFunc();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (analysisModal.classList.contains("active")) {
            closeAnalysisModalFunc();
          } else if (detailModal.classList.contains("active")) {
            closeDetailModalFunc();
          }
        } else if (analysisModal.classList.contains("active")) {
          if (e.key === "ArrowRight") nextSlide();
          else if (e.key === "ArrowLeft") prevSlide();
        }
      });

      // Auto-refresh data every 30 seconds
      setInterval(fetchData, 30000);

      // Initial load
      fetchData();
    </script>
  </body>
</html>
